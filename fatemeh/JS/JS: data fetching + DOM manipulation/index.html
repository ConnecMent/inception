<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="indexstyle.css" />
  </head>
  <body>
    <div>
      <form
        class="Search"
        name="Search"
        method="post"
        onsubmit="mySearch(event)">
        <input
          class="SearchBox"
          type="text"
          name="searchTerm"
          placeholder=" Type here to search..." />
        <button type="submit" class="SearchButton">Search</button>
        <button class="cancelButton">Cancel</button>
      </form>
      <hr class="line" />
      <div class="posts"></div>
    </div>

    <script>
      let dataArray = [];

      async function fetchData() {
        let posts = "";

        document.getElementsByClassName("cancelButton")[0].style.display =
          "none";

        const response = await fetch(
          "https://jsonplaceholder.typicode.com/posts"
        );
        const data = await response.json();
        dataArray = data;

        for (let i = 0; i < 10; i++)
          posts += `<div class=${i} id=child>
                        <h1>${dataArray[i]["title"]}</h1>
                        <h3>Author: ${dataArray[i]["userId"]}</h3>
                        <p>${dataArray[i]["body"]}</p>
                        <div>
                            <button class=update${i} id=update>Update</button>
                            <button class=delete${i} id=delete>Delete</button>
                        </div>
                        </div>`;
        posts += `<div>
                            <button class=addPost>+ Add Post</button>
                        </div>`;
        document.getElementsByClassName("posts")[0].innerHTML = posts;

        for (let i = 0; i < 10; i++) {
          const updateButton = document.querySelector(`.update${i}`);
          updateButton.addEventListener("click", () => {
            updatePost(i);
          });
          const deleteButton = document.querySelector(`.delete${i}`);
          deleteButton.addEventListener("click", () => {
            deletePost(i);
          });
        }
        const addPostButton = document.querySelector(".addPost");
        addPostButton.addEventListener("click", () => {
          addNewPost();
        });
      }
      function updatePost(id) {
        let newBody = prompt(
          "Please type your description: ",
          dataArray[id]["body"]
        );
        if (newBody != null) {
          document
            .getElementsByClassName(id)[0]
            .getElementsByTagName("p")[0].style.color = "#384fc2";
          document
            .getElementsByClassName(id)[0]
            .getElementsByTagName("p")[0].style.fontWeight = "bold";
          document
            .getElementsByClassName(id)[0]
            .getElementsByTagName("p")[0].innerHTML = "Pending...";
          fetch("https://jsonplaceholder.typicode.com/posts/".concat(id + 1), {
            method: "PUT",
            body: JSON.stringify({
              id: dataArray[id]["id"],
              title: dataArray[id]["title"],
              body: newBody,
              userId: dataArray[id]["userId"],
            }),
            headers: {
              "Content-type": "application/json; charset=UTF-8",
            },
          })
            .then((response) => response.json())
            .then((json) => newStyle(id, newBody));
        }
      }
      function newStyle(id, newBody) {
        document
          .getElementsByClassName(id)[0]
          .getElementsByTagName("p")[0].style.color = "#384fc2";
        document
          .getElementsByClassName(id)[0]
          .getElementsByTagName("p")[0].style.fontWeight = "normal";

        document
          .getElementsByClassName(id)[0]
          .getElementsByTagName("p")[0].innerHTML = newBody;
      }
      function deletePost(id) {
        let deletePost = confirm("Are you sure?");
        if (deletePost) {
          document
            .getElementsByClassName(id)[0]
            .getElementsByTagName("p")[0].style.color = "#384fc2";

          document
            .getElementsByClassName(id)[0]
            .getElementsByTagName("p")[0].style.fontWeight = "bold";

          document
            .getElementsByClassName(id)[0]
            .getElementsByTagName("p")[0].innerHTML = "Pending...";
          fetch("https://jsonplaceholder.typicode.com/posts/".concat(id + 1), {
            method: "DELETE",
          })
            .then((response) => response.json())

            .then((json) =>
              document
                .getElementsByClassName("posts")[0]
                .removeChild(document.getElementsByClassName(id)[0])
            );
        }
      }
      function addNewPost() {
        location.replace("./addpost.html");
      }
      function cancelSearch() {
        document.getElementsByClassName("cancelButton")[0].style.display =
          "inline";
        document.getElementsByClassName("SearchBox")[0].value = "";
        fetchData();
      }
      async function mySearch(event) {
        event.preventDefault();
        let searchText = document.forms["Search"]["searchTerm"].value;
        if (searchText == "") {
        } else {
          const response = await fetch(
            `https://jsonplaceholder.typicode.com/posts?title=${searchText}`
          );
          document.getElementsByClassName("cancelButton")[0].style.display =
            "inline";
          const data = await response.json();
          dataArray = data;
          document.getElementsByClassName("posts")[0].innerHTML = "";
          console.log(data);
          for (let i = 0; i < data.length; i++)
            document.getElementsByClassName(
              "posts"
            )[0].innerHTML += `<div class=${i} id=child>
                        <h1>${dataArray[i]["title"]}</h1>
                        <h3>Author: ${dataArray[i]["userId"]}</h3>
                        <p>${dataArray[i]["body"]}</p>
                        <div>
                            <button class=update${i} id=update>Update</button>
                            <button class=delete${i} id=delete>Delete</button>
                        </div>
                        </div>`;

          for (let i = 0; i < data.length; i++) {
            const updateButton = document.querySelector(`.update${i}`);
            updateButton.addEventListener("click", () => {
              updatePost(i);
            });
            const deleteButton = document.querySelector(`.delete${i}`);
            deleteButton.addEventListener("click", () => {
              deletePost(i);
            });
          }
          // document.getElementsByClassName("Search")[0].innerHTML =
          // '<input class="SearchBox" type="text" name="searchTerm"placeholder=" Type here to search..." /><button type="submit" class="SearchButton">Search</button><button class="cancelButton">Cancel</button>';
          // getElementsByClassName("cancelButton").style.visibility = "visible";
          document.getElementsByClassName("cancelButton")[0].style.display =
            "inline";
          document.getElementsByClassName("SearchBox")[0].value = searchText;
          const cancelButtonClick = document.querySelector(".cancelButton");
          cancelButtonClick.addEventListener("click", () => {
            cancelSearch();
          });
        }
      }

      fetchData();
    </script>
  </body>
</html>
